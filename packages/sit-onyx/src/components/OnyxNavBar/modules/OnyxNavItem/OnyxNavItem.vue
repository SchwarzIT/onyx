<script lang="ts" setup>
// this layout component is only used internally for the nav button component
// to easily switch between mobile and desktop layout
import arrowSmallLeft from "@sit-onyx/icons/arrow-small-left.svg?raw";
import { computed, inject, provide } from "vue";
import { useLink } from "../../../../composables/useLink";
import { useMoreListChild } from "../../../../composables/useMoreList";
import { useVModel, type Nullable } from "../../../../composables/useVModel";
import { injectI18n } from "../../../../i18n";
import { mergeVueProps } from "../../../../utils/attrs";
import OnyxButton from "../../../OnyxButton/OnyxButton.vue";
import {
  MOBILE_NAV_BAR_INJECTION_KEY,
  NAV_BAR_IS_TOP_LEVEL_INJECTION_KEY,
  NAV_BAR_MORE_LIST_INJECTION_KEY,
} from "../../types";
import OnyxFlyoutMenu from "../OnyxFlyoutMenu/OnyxFlyoutMenu.vue";
import OnyxNavItemFacade from "../OnyxNavItemFacade/OnyxNavItemFacade.vue";
import OnyxNavSeparator from "../OnyxNavSeparator/OnyxNavSeparator.vue";
import type { OnyxNavItemProps } from "./types";

const props = withDefaults(defineProps<OnyxNavItemProps>(), {
  active: "auto",
  open: undefined,
});

const emit = defineEmits<{
  /**
   * Emitted when the state of mobile children visibility changes.
   */
  "update:open": [value: Nullable<boolean>];
}>();

const slots = defineSlots<{
  /**
   * You can replace the label of the menuitem with your custom content.
   */
  default?(): unknown;
  /**
   * OnyxNavItem Children can be nested here.
   */
  children?(): unknown;
}>();

const { t } = injectI18n();

/**
 * Controls the open state.
 */
const open = useVModel({
  props,
  emit,
  key: "open",
  initialValue: false,
});

const hasChildren = computed(() => !!slots.children);

const { isActive } = useLink();
const active = computed(() => {
  if (props.active !== "auto") return props.active;
  return isActive.value(props.link);
});

const { componentRef, isVisible } = useMoreListChild(NAV_BAR_MORE_LIST_INJECTION_KEY);

const isMobile = inject(
  MOBILE_NAV_BAR_INJECTION_KEY,
  computed(() => false),
);

const isTopLevel = inject(NAV_BAR_IS_TOP_LEVEL_INJECTION_KEY, true);
provide(NAV_BAR_IS_TOP_LEVEL_INJECTION_KEY, false);
</script>

<template>
  <div
    v-if="isMobile && open"
    :class="{
      'onyx-component': true,
      'onyx-nav-item-wrapper': true,
      'onyx-nav-item-wrapper--open': open,
    }"
  >
    <div class="onyx-nav-item-wrapper__controls">
      <OnyxButton
        :label="t('back')"
        mode="plain"
        color="neutral"
        :icon="arrowSmallLeft"
        @click="open = false"
      />

      <template v-if="props.link">
        <OnyxNavItemFacade v-bind="props" :active context="mobile">
          <slot></slot>
        </OnyxNavItemFacade>
        <OnyxNavSeparator orientation="horizontal" />
      </template>
    </div>
    <ul role="menu" class="onyx-nav-item-wrapper__mobile-children">
      <slot name="children"></slot>
    </ul>
  </div>
  <OnyxNavItemFacade
    v-else-if="isMobile"
    v-bind="props"
    :active
    context="mobile"
    @click="hasChildren && (open = true)"
  >
    <slot></slot>
    <template v-if="slots.children" #children><slot name="children"></slot></template>
  </OnyxNavItemFacade>
  <template v-else>
    <OnyxFlyoutMenu
      v-if="isTopLevel && hasChildren"
      v-show="isVisible"
      :label="t('navItemOptionsLabel', { label: props.label })"
    >
      <template #button="{ trigger }">
        <OnyxNavItemFacade
          v-bind="mergeVueProps<any>(props, trigger)"
          ref="componentRef"
          :active
          context="navbar"
        >
          <slot></slot>
          <template v-if="slots.children" #children><slot name="children"></slot></template>
        </OnyxNavItemFacade>
      </template>

      <template #options>
        <slot name="children"></slot>
      </template>
    </OnyxFlyoutMenu>
    <OnyxNavItemFacade
      v-else-if="isTopLevel"
      v-bind="props"
      ref="componentRef"
      :active
      context="navbar"
    >
      <slot></slot>
    </OnyxNavItemFacade>
    <OnyxNavItemFacade v-else v-bind="props" :active context="list">
      <slot></slot>
    </OnyxNavItemFacade>
  </template>
</template>

<style lang="scss">
@use "../../../../styles/mixins/layers";

.onyx-nav-item-wrapper {
  @include layers.component() {
    &__mobile-children,
    &--open {
      padding: 0;
      width: 100%;

      display: flex;
      flex-direction: column;
      gap: var(--onyx-spacing-2xs);
    }

    &__controls {
      display: contents;
    }

    &--open:has(&--open) > &__controls {
      display: none;
    }
  }
}

.onyx-nav-item {
  @include layers.component() {
    &:has(~ .onyx-nav-item-wrapper--open),
    .onyx-nav-item-wrapper--open ~ & {
      display: none;
    }
  }
}
</style>
