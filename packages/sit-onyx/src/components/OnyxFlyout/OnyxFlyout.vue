<script setup lang="ts" generic="TValue extends SelectOptionValue = SelectOptionValue">
import {
  computed,
  nextTick,
  onMounted,
  ref,
  useId,
  useTemplateRef,
  watch,
  type AriaAttributes,
} from "vue";
import {
  useAnchorPositionPolyfill,
  USERAGENT_SUPPORTS_ANCHOR_API,
} from "../../composables/useAnchorPositionPolyfill";
import type { SelectOptionValue } from "../../types";
import type { OnyxFlyoutProps } from "./types";

const props = withDefaults(defineProps<OnyxFlyoutProps>(), {
  position: "bottom",
});

defineSlots<{
  /**
   * The always visible parent to which the flyout is aligned.
   * `trigger` can optionally set to a button to explicitly connect the the button and popover.
   */
  default(params: { trigger: AriaAttributes }): unknown;
  /**
   * Content shown in the flyout when it is expanded.
   */
  content: unknown;
}>();

const _isVisible = ref(false);
const isVisible = computed({
  set: (newVal) => (_isVisible.value = newVal),
  get: () => (typeof props.expanded === "boolean" ? props.expanded : _isVisible.value),
});

const flyoutPosition = computed(() => props.position);

const flyoutRef = useTemplateRef("flyout");
const flyoutWrapperRef = useTemplateRef("flyoutWrapper");
const { leftPosition, topPosition, updateAnchorPositionPolyfill } = useAnchorPositionPolyfill({
  positionedRef: flyoutRef,
  targetRef: flyoutWrapperRef,
  positionArea: flyoutPosition,
  alignment: "center",
  alignsWithEdge: false,
  fitParent: false,
});

const handleOpening = (open: boolean) => {
  if (open) {
    flyoutRef.value?.showPopover();
  } else {
    flyoutRef.value?.hidePopover();
  }
};

// initial update
onMounted(() => {
  handleOpening(isVisible.value);
  if (!USERAGENT_SUPPORTS_ANCHOR_API) updateAnchorPositionPolyfill();
});

// update open direction when visibility changes to ensure the tooltip is always visible
watch(isVisible, async (newVal) => {
  await nextTick();
  handleOpening(newVal);
  if (!USERAGENT_SUPPORTS_ANCHOR_API) updateAnchorPositionPolyfill();
});

const toggle = () => {
  _isVisible.value = !_isVisible.value;
};

const trigger = computed(() => ({
  onClick: toggle,
  "aria-expanded": isVisible.value,
  "aria-controls": flyoutRef.value?.id,
}));

const id = useId();
const anchorName = computed(() => `--anchor-${id}`);

const flyoutClasses = computed(() => {
  return {
    [`onyx-flyout__modal--position-${flyoutPosition.value.replace(" ", "-")}`]: true,
    "onyx-flyout__modal--dont-support-anchor": !USERAGENT_SUPPORTS_ANCHOR_API,
  };
});

watch([flyoutPosition], async () => {
  if (!USERAGENT_SUPPORTS_ANCHOR_API) {
    await nextTick();
    updateAnchorPositionPolyfill();
  }
});
</script>

<template>
  <div ref="flyoutWrapper" class="onyx-component onyx-flyout" :style="`anchor-name: ${anchorName}`">
    <slot :trigger="trigger"></slot>
    <div
      ref="flyout"
      role="dialog"
      :aria-label="props.label"
      popover="manual"
      class="onyx-flyout__modal"
      :class="flyoutClasses"
    >
      <slot name="content"></slot>
    </div>
  </div>
</template>

<style lang="scss">
@use "../../styles/mixins/layers";

.onyx-flyout {
  @include layers.component() {
    --onyx-flyout-gap: var(--onyx-spacing-2xs);
    display: inline-flex;
    position: relative;
    width: min-content;

    &__modal {
      position: fixed;
      position-anchor: v-bind("anchorName");
      position-area: v-bind("flyoutPosition");

      border-radius: var(--onyx-radius-md);
      background-color: var(--onyx-color-base-background-blank);
      padding: 0;
      box-shadow: var(--onyx-shadow-medium-bottom);
      box-sizing: border-box;
      width: max-content;
      min-width: var(--onyx-spacing-4xl);
      max-width: 20rem;
      font-family: var(--onyx-font-family);

      &--dont-support-anchor {
        left: v-bind(leftPosition);
        top: v-bind(topPosition);
      }

      &:popover-open {
        border: none;
        outline: none;
        background-color: var(--onyx-color-base-background-blank);
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      &--position-right {
        margin-left: var(--onyx-flyout-gap);
      }
      &--position-left {
        margin-right: var(--onyx-flyout-gap);
      }
      &--position-bottom {
        margin-top: var(--onyx-flyout-gap);
      }
      &--position-bottom-right {
        margin-top: var(--onyx-flyout-gap);
        margin-left: var(--onyx-flyout-gap);
      }
      &--position-bottom-left {
        margin-top: var(--onyx-flyout-gap);
        margin-right: var(--onyx-flyout-gap);
      }
      &--position-top {
        margin-bottom: var(--onyx-flyout-gap);
        margin-left: var(--onyx-flyout-gap);
      }
      &--position-top-right {
        margin-bottom: var(--onyx-flyout-gap);
      }
      &--position-top-left {
        margin-bottom: var(--onyx-flyout-gap);
        margin-right: var(--onyx-flyout-gap);
      }
    }
  }
}
.dark .onyx-flyout-menu__list {
  @include layers.component() {
    outline: var(--onyx-1px-in-rem) solid var(--onyx-color-component-border-neutral);
  }
}
</style>
