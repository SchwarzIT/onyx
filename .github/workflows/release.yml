# âš ï¸ DO NOT RENAME FILE - WILL BREAK RELEASES âš ï¸
# This file is used for trusted publishing with npm. Learn more here: https://docs.npmjs.com/trusted-publishers
name: Release
on:
  push:
    branches:
      - "main"
  workflow_dispatch:

concurrency: ${{ github.workflow }}-${{ github.ref }}

env:
  TURBO_TOKEN: ${{ secrets.TURBO_REMOTE_CACHE__TURBO_TOKEN }}

permissions:
  contents: read

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write
      packages: write
      pull-requests: write
    outputs:
      # We can use the `published` boolean in other steps to decide, when we do deployments
      published: ${{ steps.Publish.outputs.published }}
      is_snapshot_release: ${{ steps.DetermineSnapshotRelease.outputs.IS_SNAPSHOT_RELEASE }}

    steps:
      - name: "ðŸ›ƒ Harden the runner (Audit all outbound calls)"
        uses: step-security/harden-runner@a90bcbc6539c36a85cdfeb73f7e2f433735f215b # v2.15.0
        with:
          egress-policy: audit

      - name: "ðŸ›’ Checkout Repository"
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ssh-key: ${{ secrets.GH_PUSH_PROTECTED_KEY }}
          # needed when building VitePress docs so timestamps can be calculated correctly
          fetch-depth: 0

      - uses: ./.github/templates/node-setup

      - name: ðŸ› ï¸ Build packages
        run: pnpm build:all --filter=!./apps/*

      - name: ðŸ¤– Configure Git Bot
        run: |
          git config user.name "Release Bot[bot]"
          git config user.email "bot@example.com"

      # All existing changesets are applied for a snapshot release.
      # In case of a "real" release all changesets will already have been applied through a PR, so this step won't have an effect.
      - name: Determine snapshot release
        id: DetermineSnapshotRelease
        run: |
          pnpm exec changeset status --output=snapshot.json
          IS_SNAPSHOT_RELEASE=$(cat snapshot.json | jq -r '(.releases | length) > 0')
          rm snapshot.json
          if [[ $IS_SNAPSHOT_RELEASE == "true" ]]; then
            pnpm exec changeset version --snapshot dev
            echo "IS_SNAPSHOT_RELEASE=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Publish
        id: Publish
        uses: changesets/action@6a0a831ff30acef54f2c6aa1cbbc1096b066edaf # v1.7.0
        with:
          publish: pnpm exec changeset publish ${{ (steps.DetermineSnapshotRelease.outputs.IS_SNAPSHOT_RELEASE && '--tag dev') || '' }}
          createGithubReleases: ${{ steps.DetermineSnapshotRelease.outputs.IS_SNAPSHOT_RELEASE != 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy-websites:
    name: deploy-websites
    needs: release
    if: needs.release.outputs.published == 'true'
    uses: ./.github/workflows/deploy-websites.yml
    with:
      environment: ${{ needs.release.outputs.is_snapshot_release && 'dev' || 'prod' }}
    secrets: inherit
