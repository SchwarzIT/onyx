name: Deploy
on:
  push:
    branches:
      - main
    paths:
      - "packages/sit-onyx/**"
  workflow_dispatch:
    inputs:
      stage:
        description: Stage to deploy to
        type: choice
        required: true
        default: dev
        options:
          - "dev"

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: .node-version
          cache: pnpm

      - name: üì¶ Install dependencies
        run: pnpm install

      - name: üõ†Ô∏è Build Storybook
        run: pnpm run build:storybook
        working-directory: packages/sit-onyx

      - name: üõ†Ô∏è Build documentation
        run: pnpm run build
        working-directory: apps/docs

      - name: Upload Storybook artifact
        uses: actions/upload-artifact@v3
        with:
          name: storybook-static
          path: packages/sit-onyx/storybook-static

      - name: Upload documentation artifact
        uses: actions/upload-artifact@v3
        with:
          name: documentation
          path: apps/docs/src/.vitepress/dist

  deploy_storybook:
    name: Deploy Storybook
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4

      - name: Download Storybook artifact
        uses: actions/download-artifact@v3
        with:
          name: storybook-static
          path: packages/sit-onyx/.cloud-foundry/storybook-static

      - name: Deploy to Cloud Foundry
        uses: ./.github/templates/cf-push
        with:
          cf-endpoint: ${{ secrets.CF_ENDPOINT }}
          cf-org: ${{ secrets.CF_ORG }}
          cf-username: ${{ secrets.CF_USERNAME }}
          cf-password: ${{ secrets.CF_PASSWORD }}
          # we need to define a fallback value here because the default for the input
          # is only assigned when the workflow is triggered manually. When triggered e.g. on push
          # the input will be unset so a fallback is needed here
          cf-space: ${{ inputs.stage || 'dev' }}
          working-directory: packages/sit-onyx/.cloud-foundry

  deploy_documentation:
    name: Deploy documentation
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4

      - name: Download Storybook artifact
        uses: actions/download-artifact@v3
        with:
          name: documentation
          path: apps/docs/.cloud-foundry/dist

      - name: Deploy to Cloud Foundry
        uses: ./.github/templates/cf-push
        with:
          cf-endpoint: ${{ secrets.CF_ENDPOINT }}
          cf-org: ${{ secrets.CF_ORG }}
          cf-username: ${{ secrets.CF_USERNAME }}
          cf-password: ${{ secrets.CF_PASSWORD }}
          # we need to define a fallback value here because the default for the input
          # is only assigned when the workflow is triggered manually. When triggered e.g. on push
          # the input will be unset so a fallback is needed here
          cf-space: ${{ inputs.stage || 'dev' }}
          working-directory: apps/docs/.cloud-foundry
