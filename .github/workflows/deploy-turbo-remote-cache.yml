name: Deploy Turbo Remote Cache
on:
  push:
    branches:
      - "main"
    paths:
      - "apps/turbo-remote-cache/**"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy:
    name: Deploy to CloudFoundry
    runs-on: ubuntu-latest
    environment: prod
    steps:
      - name: "ðŸ›ƒ Harden the runner (Audit all outbound calls)"
        uses: step-security/harden-runner@a90bcbc6539c36a85cdfeb73f7e2f433735f215b # v2.15.0
        with:
          egress-policy: audit
      - name: "ðŸ›’ Checkout Repository"
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Deploy to Cloud Foundry
        uses: ./.github/templates/cf-push
        with:
          endpoint: ${{ vars.CF_ENDPOINT }}
          org: ${{ vars.CF_ORG }}
          username: ${{ vars.CF_USERNAME }}
          password: ${{ secrets.CF_PASSWORD }}
          space: prod
          varArgs: "--var TURBO_TOKEN=${{ secrets.TURBO_REMOTE_CACHE__TURBO_TOKEN }} --var AWS_ACCESS_KEY_ID=${{ secrets.TURBO_REMOTE_CACHE__AWS_ACCESS_KEY_ID }} --var AWS_SECRET_ACCESS_KEY=${{ secrets.TURBO_REMOTE_CACHE__AWS_SECRET_ACCESS_KEY }}"
          working-directory: apps/turbo-remote-cache/.cloud-foundry
